<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - Bar</title>
    <!-- Incluimos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SCRIPT DE EEL: Necesario para la comunicación Python <-> JS -->
    <script type="text/javascript" src="/eel.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-green {
            background-color: #052e16; color: #86efac; border: 1px solid #14532d;
        }
        .price-red {
            background-color: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d;
        }
        select:disabled {
            background-color: #374151; opacity: 0.5; cursor: not-allowed;
        }
        /* Mensaje de feedback (éxito/error) */
        #feedback {
            transition: opacity 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-6 md:p-10">

        <!-- Cabecera -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-100">Gestión de Stock: Bar de Jose</h1>
            <p class="text-lg text-gray-400">Tu panel de control para inventario, compras y proveedores.</p>
        </header>

        <!-- Sección Principal: Alertas y Registro -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">

            <!-- Columna de Alertas (El núcleo de la idea) -->
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-700">Alertas Importantes</h2>
                
                <!-- (Por ahora, estas alertas son estáticas. Las haremos dinámicas en el MVP 2) -->
                
                <div class="bg-yellow-900/30 border-l-4 border-yellow-600 text-yellow-300 p-4 rounded-lg shadow-sm">
                    <div class="flex">
                        <div class="py-1">
                            <svg class="w-6 h-6 text-yellow-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold">Exceso de Stock Detectado</p>
                            <p class="text-sm">Tienes **15 kg de Pollo** en inventario (tu umbral es 10 kg).</p>
                        </div>
                    </div>
                </div>
                <div class="bg-red-900/30 border-l-4 border-red-600 text-red-300 p-4 rounded-lg shadow-sm mt-4">
                    <p class="font-bold">Próximo Vencimiento</p>
                    <p class="text-sm">**5 litros de Leche** (Proveedor: Lacteos S.A.) vencen en 2 días.</p>
                </div>
            </div>

            <!-- Columna de Registro de Compra -->
            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-700">
                    <h2 class="text-xl font-semibold">Registrar Nueva Compra</h2>
                    <!-- Mensaje de Feedback -->
                    <div id="feedback" class="text-sm opacity-0"></div>
                </div>
                
                <form id="form-compra" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Producto -->
                    <div>
                        <label for="producto" class="block text-sm font-medium text-gray-300">Producto <span class="text-red-400">*</span></label>
                        <!-- CAMBIO: Opciones se cargarán dinámicamente -->
                        <select id="producto" name="producto" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                            <option value="">-- Cargando productos... --</option>
                        </select>
                    </div>

                    <!-- Proveedor -->
                    <div>
                        <label for="proveedor" class="block text-sm font-medium text-gray-300">Proveedor</label>
                        <!-- CAMBIO: Opciones se cargarán dinámicamente -->
                        <select id="proveedor" name="proveedor" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">-- Opcional --</option>
                        </select>
                    </div>

                    <!-- Cantidad y Unidad -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="cantidad" class="block text-sm font-medium text-gray-300">Cantidad</label>
                            <input type="number" name="cantidad" id="cantidad" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ej: 5">
                        </div>
                        <div>
                            <label for="unidad" class="block text-sm font-medium text-gray-300">Unidad <span class="text-red-400">*</span></label>
                            <select id="unidad" name="unidad" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required disabled>
                                <option value="">-- Elige producto --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Precio Total -->
                    <div>
                        <label for="precio" class="block text-sm font-medium text-gray-300">Precio Total (€)</label>
                        <input type="number" step="0.01" name="precio" id="precio" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ej: 15.50">
                    </div>

                    <!-- Fecha de Compra (con override) -->
                    <div class="md:col-span-1">
                        <label for="fecha_compra" class="block text-sm font-medium text-gray-300">Fecha de Compra</label>
                        <input type="date" name="fecha_compra" id="fecha_compra" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" style="color-scheme: dark;">
                    </div>

                    <!-- Descuento -->
                    <div class="md:col-span-1">
                        <label for="descuento" class="block text-sm font-medium text-gray-300">Descuento (Opcional)</label>
                        <input type="text" name="descuento" id="descuento" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Ej: 10% por volumen">
                    </div>

                    <!-- Botón de Guardar -->
                    <div class="md:col-span-2 text-right">
                        <button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Guardar Compra
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sección de Comparación de Precios (El Semáforo) -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-100">Comparador de Precios: Patatas (por kg)</h2>
            <!-- (Por ahora, esta tabla es estática. La haremos dinámica en el MVP 2) -->
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Proveedor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Última Compra</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Precio / kg</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Descuento Aplicado</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">Distribuidora Central</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">14/11/2025 (5 kg)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                <span class="px-3 py-1 rounded-full text-sm price-red">1.90 € / kg</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">Ninguno</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">Verdulería Pepe</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">12/11/2025 (10 kg)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                                <span class="px-3 py-1 rounded-full text-sm price-green">1.88 € / kg</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">Desc. por 10kg</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- =========== LÓGICA DE JAVASCRIPT =========== -->
    <script>
        // --- Mapa de unidades (lo recibiremos de Python) ---
        let unidadesValidasMap = {};

        // --- Elementos del DOM ---
        const productoSelect = document.getElementById('producto');
        const unidadSelect = document.getElementById('unidad');
        const proveedorSelect = document.getElementById('proveedor');
        const formCompra = document.getElementById('form-compra');
        const fechaCompraInput = document.getElementById('fecha_compra');
        const feedbackEl = document.getElementById('feedback');

        // --- Lógica de Carga Inicial ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Poner fecha de hoy por defecto
            fechaCompraInput.value = new Date().toISOString().split('T')[0];
            
            // 2. Pedir datos iniciales a Python
            console.log("Pidiendo datos iniciales a Python...");
            const datos = await eel.get_datos_iniciales()(); // Doble paréntesis es correcto para eel
            
            if (datos.error) {
                console.error(datos.error);
                productoSelect.innerHTML = '<option value="">Error al cargar</option>';
                return;
            }
            
            console.log("Datos recibidos:", datos);
            
            // 3. Guardar el mapa de unidades
            unidadesValidasMap = datos.unidades_map;
            
            // 4. Rellenar <select> de Productos
            productoSelect.innerHTML = '<option value="">-- Selecciona un producto --</option>';
            datos.productos.forEach(prod => {
                productoSelect.add(new Option(prod, prod));
            });
            
            // 5. Rellenar <select> de Proveedores
            proveedorSelect.innerHTML = '<option value="">-- Opcional --</option>';
            datos.proveedores.forEach(prov => {
                proveedorSelect.add(new Option(prov, prov));
            });
        });

        // --- Lógica de Unidades Condicionales ---
        productoSelect.addEventListener('change', (event) => {
            const productoElegido = event.target.value;
            unidadSelect.innerHTML = ''; // Limpiar opciones

            if (productoElegido && unidadesValidasMap[productoElegido]) {
                unidadSelect.disabled = false;
                unidadSelect.add(new Option("-- Selecciona unidad --", ""));
                
                unidadesValidasMap[productoElegido].forEach(unidad => {
                    unidadSelect.add(new Option(unidad, unidad));
                });
            } else {
                unidadSelect.add(new Option("-- Elige producto --", ""));
                unidadSelect.disabled = true;
            }
        });

        // --- Lógica de Guardar Compra ---
        formCompra.addEventListener('submit', async (event) => {
            event.preventDefault(); // Evitar que el formulario se envíe de forma tradicional
            
            // 1. Recolectar datos del formulario
            const formData = new FormData(formCompra);
            const datos = Object.fromEntries(formData.entries());
            
            console.log("Enviando a Python:", datos);
            
            // 2. Enviar datos a Python usando Eel
            const resultado = await eel.guardar_compra_validada(datos)();
            
            // 3. Mostrar feedback al usuario
            if (resultado.success) {
                mostrarFeedback("Compra guardada con éxito", "success");
                formCompra.reset(); // Limpiar el formulario
                // Resetear campos dinámicos
                fechaCompraInput.value = new Date().toISOString().split('T')[0];
                unidadSelect.innerHTML = '<option value="">-- Elige producto --</option>';
                unidadSelect.disabled = true;
                productoSelect.value = "";
                proveedorSelect.value = "";
            } else {
                mostrarFeedback(`Error: ${resultado.error}`, "error");
            }
        });
        
        // --- Función de Feedback Visual ---
        function mostrarFeedback(mensaje, tipo) {
            feedbackEl.textContent = mensaje;
            if (tipo === 'success') {
                feedbackEl.className = 'text-sm text-green-400 opacity-100';
            } else {
                feedbackEl.className = 'text-sm text-red-400 opacity-100';
            }
            
            // Ocultar el mensaje después de 3 segundos
            setTimeout(() => {
                feedbackEl.className = 'text-sm opacity-0';
            }, 3000);
        }

    </script> 
</body>
</html>