<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Vol√∫menes - Bar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="/eel.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-green {
            background-color: #052e16; color: #86efac; border: 1px solid #14532d;
        }
        .price-red {
            background-color: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d;
        }
        .alert-high { background-color: #450a0a; border-left: 4px solid #dc2626; }
        .alert-medium { background-color: #451a03; border-left: 4px solid #ea580c; }
        .alert-low { background-color: #1e3a8a; border-left: 4px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-6 md:p-10">

        <!-- Navegaci√≥n -->
        <nav class="mb-8">
            <div class="flex space-x-4 border-b border-gray-700">
                <a href="index.html" class="px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-t-lg transition-colors">
                    ‚Üê Registro de Compras
                </a>
                <a href="analytics.html" class="px-4 py-2 text-white bg-gray-800 rounded-t-lg border-b-2 border-blue-500">
                    üìä An√°lisis
                </a>
            </div>
        </nav>

        <!-- Cabecera -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-100">An√°lisis de Vol√∫menes y Precios</h1>
            <p class="text-lg text-gray-400">An√°lisis detallado de tus compras y optimizaci√≥n de costos</p>
        </header>

        <!-- Secci√≥n de Alertas Din√°micas -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-100">üö® Alertas Activas</h2>
            <div id="alertas-container" class="space-y-3">
                <!-- Alertas se cargar√°n din√°micamente -->
                <div class="bg-gray-800 p-4 rounded-lg text-gray-400">
                    Cargando alertas...
                </div>
            </div>
        </div>

        <!-- Filtros de An√°lisis -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-100">Filtros de An√°lisis</h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fecha-inicio" class="block text-sm font-medium text-gray-300">Fecha Inicio</label>
                    <input type="date" id="fecha-inicio" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="fecha-fin" class="block text-sm font-medium text-gray-300">Fecha Fin</label>
                    <input type="date" id="fecha-fin" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="producto-filtro" class="block text-sm font-medium text-gray-300">Producto (Opcional)</label>
                    <select id="producto-filtro" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="">Todos los productos</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="cargarAnalisis()" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Analizar
                    </button>
                </div>
            </div>

            <div class="mt-4 flex space-x-4">
                <button onclick="exportarCSV()" class="inline-flex items-center px-4 py-2 border border-gray-600 shadow-sm text-sm font-medium rounded-lg text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    üì• Exportar CSV
                </button>
                <button onclick="cargarResumenGeneral()" class="inline-flex items-center px-4 py-2 border border-gray-600 shadow-sm text-sm font-medium rounded-lg text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    üìà Resumen General
                </button>
            </div>
        </div>

        <!-- Resultados del An√°lisis -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-100">üìä Resultados del An√°lisis</h2>

            <div id="analisis-container">
                <div class="text-center py-8 text-gray-400">
                    Selecciona un per√≠odo y haz clic en "Analizar" para ver los resultados
                </div>
            </div>
        </div>

        <!-- Comparador de Proveedores -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-100">‚öñÔ∏è Comparador de Proveedores</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="proveedor-producto" class="block text-sm font-medium text-gray-300">Producto</label>
                    <select id="proveedor-producto" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="">Selecciona un producto</option>
                    </select>
                </div>
                <div>
                    <label for="proveedor-dias" class="block text-sm font-medium text-gray-300">D√≠as de an√°lisis</label>
                    <select id="proveedor-dias" class="mt-1 block w-full rounded-lg border-gray-600 bg-gray-700 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="30">√öltimos 30 d√≠as</option>
                        <option value="60">√öltimos 60 d√≠as</option>
                        <option value="90">√öltimos 90 d√≠as</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="cargarComparadorProveedores()" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Comparar
                    </button>
                </div>
            </div>

            <div id="comparador-container">
                <div class="text-center py-8 text-gray-400">
                    Selecciona un producto para ver la comparaci√≥n de proveedores
                </div>
            </div>
        </div>

        <!-- Modal de Resumen General -->
        <div id="resumenModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-gray-800 border-gray-700">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-100">üìà Resumen General del Inventario</h3>
                        <button onclick="cerrarResumen()" class="text-gray-400 hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="resumen-content" class="space-y-4">
                        <!-- Contenido din√°mico -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========== L√ìGICA DE JAVASCRIPT =========== -->
    <script>
        // --- Variables Globales ---
        let productos = [];
        let analisisActual = [];

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Establecer fechas por defecto (√∫ltimo mes)
            const hoy = new Date();
            const haceUnMes = new Date(hoy.getFullYear(), hoy.getMonth() - 1, hoy.getDate());

            document.getElementById('fecha-inicio').value = haceUnMes.toISOString().split('T')[0];
            document.getElementById('fecha-fin').value = hoy.toISOString().split('T')[0];

            // Cargar productos
            await cargarProductos();

            // Cargar alertas autom√°ticamente
            await cargarAlertas();
        });

        async function cargarProductos() {
            try {
                const datos = await eel.get_datos_iniciales()();
                productos = datos.productos;

                // Llenar selects de productos
                const selects = ['producto-filtro', 'proveedor-producto'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = selectId === 'producto-filtro'
                        ? '<option value="">Todos los productos</option>'
                        : '<option value="">Selecciona un producto</option>';

                    productos.forEach(prod => {
                        select.add(new Option(prod, prod));
                    });
                });
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }

        async function cargarAlertas() {
            try {
                const alertas = await eel.generar_alertas()();
                const container = document.getElementById('alertas-container');

                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="bg-green-900/30 border-l-4 border-green-600 text-green-300 p-4 rounded-lg">
                            <p class="font-semibold">‚úÖ Todo en orden</p>
                            <p class="text-sm">No hay alertas activas en este momento.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = alertas.map(alerta => {
                    const alertClass = alerta.prioridad === 'alta' ? 'alert-high' :
                                      alerta.prioridad === 'media' ? 'alert-medium' : 'alert-low';

                    const icon = alerta.tipo === 'warning' ? '‚ö†Ô∏è' :
                                alerta.tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';

                    return `
                        <div class="${alertClass} text-gray-300 p-4 rounded-lg">
                            <div class="flex items-start">
                                <span class="text-xl mr-3">${icon}</span>
                                <div class="flex-1">
                                    <p class="font-semibold">${alerta.titulo}</p>
                                    <p class="text-sm">${alerta.mensaje}</p>
                                    ${alerta.datos.ahorro_potencial ?
                                        `<p class="text-xs text-gray-400 mt-1">Ahorro potencial: ‚Ç¨${alerta.datos.ahorro_potencial.toFixed(2)}</p>`
                                        : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error cargando alertas:', error);
                document.getElementById('alertas-container').innerHTML =
                    '<div class="bg-red-900/30 border-l-4 border-red-600 text-red-300 p-4 rounded-lg">Error cargando alertas</div>';
            }
        }

        async function cargarAnalisis() {
            const inicio = document.getElementById('fecha-inicio').value;
            const fin = document.getElementById('fecha-fin').value;
            const producto = document.getElementById('producto-filtro').value;

            if (!inicio || !fin) {
                alert('Por favor selecciona ambas fechas');
                return;
            }

            try {
                const container = document.getElementById('analisis-container');
                container.innerHTML = '<div class="text-center py-8">Analizando datos...</div>';

                const datos = await eel.analizar_volumenes_periodo(inicio, fin, producto || null)();
                analisisActual = datos;

                if (datos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p>No se encontraron compras en el per√≠odo seleccionado</p>
                            <p class="text-sm mt-2">Intenta con un rango de fechas diferente</p>
                        </div>
                    `;
                    return;
                }

                // Renderizar tabla
                container.innerHTML = `
                    <div class="overflow-x-auto rounded-lg border border-gray-700">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Compras</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volumen Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Gasto Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Precio Promedio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rango de Precios</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ahorro Potencial</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-800 divide-y divide-gray-700">
                                ${datos.map(d => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${d.producto}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${d.num_compras}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${d.volumen_total} ${d.unidad}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">‚Ç¨${d.gasto_total.toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">‚Ç¨${d.precio_promedio.toFixed(4)}/${d.unidad}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <span class="text-green-400">‚Ç¨${d.mejor_precio.toFixed(4)}</span> -
                                            <span class="text-red-400">‚Ç¨${d.peor_precio.toFixed(4)}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${d.ahorro_potencial > 10 ? 'text-green-400' : 'text-gray-400'}">
                                            ‚Ç¨${d.ahorro_potencial.toFixed(2)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 text-sm text-gray-400">
                        <p>Total: ${datos.length} productos |
                        Volumen analizado: ${datos.reduce((sum, d) => sum + d.volumen_total, 0).toFixed(1)} unidades |
                        Gasto total: ‚Ç¨${datos.reduce((sum, d) => sum + d.gasto_total, 0).toFixed(2)}</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error en an√°lisis:', error);
                document.getElementById('analisis-container').innerHTML =
                    '<div class="text-center py-8 text-red-400">Error al realizar el an√°lisis</div>';
            }
        }

        async function cargarComparadorProveedores() {
            const producto = document.getElementById('proveedor-producto').value;

            if (!producto) {
                alert('Por favor selecciona un producto');
                return;
            }

            try {
                const container = document.getElementById('comparador-container');
                container.innerHTML = '<div class="text-center py-8">Comparando proveedores...</div>';

                const datos = await eel.comparar_proveedores(producto)();

                if (datos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <p>No se encontraron compras comparables para ${producto}</p>
                            <p class="text-sm mt-2">Intenta con otro producto</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="overflow-x-auto rounded-lg border border-gray-700">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Proveedor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Precio Promedio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Variaci√≥n</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Compras</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Volumen</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">√öltima Compra</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-800 divide-y divide-gray-700">
                                ${datos.map(d => `
                                    <tr class="${d.es_mejor ? 'bg-green-900/20' : ''}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                                            ${d.proveedor}
                                            ${d.es_mejor ? '<span class="ml-2 text-green-400">‚òÖ Mejor Precio</span>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <span class="px-3 py-1 rounded-full text-sm ${d.es_mejor ? 'price-green' : 'price-red'}">
                                                ‚Ç¨${d.precio_promedio.toFixed(4)}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                                            ‚Ç¨${d.precio_min.toFixed(4)} - ‚Ç¨${d.precio_max.toFixed(4)}
                                            ${d.variacion_precio > 0.01 ? `<span class="text-orange-400">(${(d.variacion_precio/d.precio_promedio*100).toFixed(1)}%)</span>` : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${d.num_compras}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${d.volumen_total}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${d.ultima_compra}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('Error comparando proveedores:', error);
                document.getElementById('comparador-container').innerHTML =
                    '<div class="text-center py-8 text-red-400">Error al comparar proveedores</div>';
            }
        }

        async function exportarCSV() {
            if (analisisActual.length === 0) {
                alert('No hay datos para exportar. Primero realiza un an√°lisis.');
                return;
            }

            try {
                const inicio = document.getElementById('fecha-inicio').value;
                const fin = document.getElementById('fecha-fin').value;
                const producto = document.getElementById('producto-filtro').value;

                const filepath = await eel.exportar_analisis_csv(inicio, fin, producto || null)();

                alert(`An√°lisis exportado exitosamente:\n${filepath}`);

                // Opcional: abrir la carpeta donde se guard√≥ el archivo
                // window.open(`file://${filepath.replace(/\\\\/g, '/')}`, '_blank');

            } catch (error) {
                console.error('Error exportando CSV:', error);
                alert('Error al exportar el archivo CSV');
            }
        }

        async function cargarResumenGeneral() {
            try {
                const resumen = await eel.obtener_resumen_general()();
                const content = document.getElementById('resumen-content');

                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-100 mb-2">Estad√≠sticas Generales</h4>
                            <p class="text-sm text-gray-300">Total de compras: <span class="font-bold">${resumen.total_compras}</span></p>
                            <p class="text-sm text-gray-300">Gasto acumulado: <span class="font-bold">‚Ç¨${resumen.gasto_total.toFixed(2)}</span></p>
                            <p class="text-sm text-gray-300">Compras semana: <span class="font-bold">${resumen.compras_semana}</span></p>
                            <p class="text-sm text-gray-300">Gasto semana: <span class="font-bold">‚Ç¨${resumen.gasto_semana.toFixed(2)}</span></p>
                        </div>

                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-100 mb-2">Top 5 Productos</h4>
                            ${resumen.top_productos.map(p =>
                                `<p class="text-sm text-gray-300">${p.nombre}: <span class="font-bold">${p.compras}</span> compras</p>`
                            ).join('')}
                        </div>

                        <div class="bg-gray-700 p-4 rounded-lg col-span-2">
                            <h4 class="font-semibold text-gray-100 mb-2">Top 5 Proveedores</h4>
                            <div class="grid grid-cols-5 gap-2">
                                ${resumen.top_proveedores.map(p =>
                                    `<div class="text-center">
                                        <p class="text-sm font-bold text-gray-100">${p.nombre}</p>
                                        <p class="text-xs text-gray-400">${p.usos} usos</p>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('resumenModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error cargando resumen:', error);
                alert('Error al cargar el resumen general');
            }
        }

        function cerrarResumen() {
            document.getElementById('resumenModal').classList.add('hidden');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('resumenModal');
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        }
    </script>
</body>
</html>